<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MyCatBox - Cloudinary File Upload</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Header */
        header {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        h1 {
            color: #764ba2;
            margin-bottom: 10px;
            font-size: 2.5em;
        }

        h1 span {
            font-size: 0.5em;
            color: #999;
            margin-left: 10px;
        }

        .stats {
            display: flex;
            gap: 30px;
            color: #666;
            font-size: 14px;
            flex-wrap: wrap;
        }

        .stats span {
            background: #f5f5f5;
            padding: 8px 15px;
            border-radius: 20px;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }

        .badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: bold;
            margin-left: 5px;
        }

        .badge.cloudinary {
            background: #3448C5;
            color: white;
        }

        /* Upload Area */
        .upload-area {
            background: white;
            border-radius: 10px;
            padding: 40px;
            text-align: center;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            border: 3px dashed #764ba2;
            transition: all 0.3s;
        }

        .upload-area.dragover {
            background: #f0f0ff;
            border-color: #667eea;
            transform: scale(1.02);
        }

        .upload-icon {
            font-size: 64px;
            color: #764ba2;
            margin-bottom: 20px;
            animation: bounce 2s infinite;
        }

        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        .upload-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 40px;
            border-radius: 25px;
            font-size: 18px;
            cursor: pointer;
            transition: all 0.3s;
            margin: 20px 0;
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .upload-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.6);
        }

        .upload-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .file-info {
            color: #666;
            font-size: 14px;
            margin-top: 10px;
            padding: 15px;
            background: #f5f5f5;
            border-radius: 5px;
            text-align: left;
        }

        .progress-bar {
            width: 100%;
            height: 20px;
            background: #f0f0f0;
            border-radius: 10px;
            overflow: hidden;
            margin: 20px 0;
            display: none;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            width: 0%;
            transition: width 0.3s;
        }

        /* Info Box */
        .info-box {
            background: #e3f2fd;
            border-left: 4px solid #2196F3;
            padding: 15px;
            border-radius: 5px;
            margin: 20px 0;
            text-align: left;
            font-size: 14px;
        }

        .info-box.cloudinary {
            background: #e8eaf6;
            border-left-color: #3448C5;
        }

        .info-box.warning {
            background: #fff3e0;
            border-left-color: #ff9800;
        }

        /* Result Box */
        .result {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            display: none;
        }

        .result.success {
            border-left: 5px solid #4CAF50;
        }

        .result.error {
            border-left: 5px solid #f44336;
        }

        .url-box {
            background: #f5f5f5;
            padding: 15px;
            border-radius: 5px;
            margin: 15px 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 1px solid #e0e0e0;
        }

        .url-box input {
            background: transparent;
            border: none;
            flex: 1;
            font-size: 16px;
            outline: none;
            padding: 5px;
            font-family: monospace;
        }

        .copy-btn {
            background: #764ba2;
            color: white;
            border: none;
            padding: 8px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin-left: 10px;
            transition: background 0.3s;
        }

        .copy-btn:hover {
            background: #5a3d7c;
        }

        .action-buttons {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            flex-wrap: wrap;
        }

        .action-btn {
            flex: 1;
            min-width: 120px;
            padding: 12px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            transition: all 0.3s;
            color: white;
        }

        .action-btn.open {
            background: #4CAF50;
        }

        .action-btn.open:hover {
            background: #45a049;
        }

        .action-btn.download {
            background: #2196F3;
        }

        .action-btn.download:hover {
            background: #1e88e5;
        }

        .action-btn.transform {
            background: #FF9800;
        }

        .action-btn.transform:hover {
            background: #fb8c00;
        }

        /* Files Section */
        .files-section {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .files-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .files-header h3 {
            color: #764ba2;
            font-size: 1.5em;
        }

        .search-box {
            padding: 12px 20px;
            border: 2px solid #e0e0e0;
            border-radius: 25px;
            width: 300px;
            font-size: 16px;
            transition: all 0.3s;
            background: #f9f9f9;
        }

        .search-box:focus {
            outline: none;
            border-color: #764ba2;
            box-shadow: 0 0 10px rgba(118, 75, 162, 0.2);
            background: white;
        }

        .files-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .file-card {
            background: #f9f9f9;
            border-radius: 8px;
            padding: 15px;
            transition: all 0.3s;
            border: 1px solid #e0e0e0;
            position: relative;
            overflow: hidden;
        }

        .file-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0,0,0,0.15);
            border-color: #764ba2;
        }

        .file-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            transform: scaleX(0);
            transition: transform 0.3s;
        }

        .file-card:hover::before {
            transform: scaleX(1);
        }

        .file-thumbnail {
            width: 100%;
            height: 150px;
            object-fit: cover;
            border-radius: 5px;
            margin-bottom: 10px;
            background: #f0f0f0;
        }

        .file-name {
            font-weight: bold;
            margin-bottom: 10px;
            color: #764ba2;
            word-break: break-all;
            font-size: 1.1em;
            padding-right: 30px;
        }

        .file-meta {
            font-size: 12px;
            color: #888;
            margin-bottom: 15px;
            line-height: 1.6;
        }

        .file-meta span {
            display: inline-block;
            background: #e0e0e0;
            padding: 2px 8px;
            border-radius: 12px;
            margin-right: 5px;
            margin-bottom: 5px;
        }

        .file-meta .cloudinary-badge {
            background: #3448C5;
            color: white;
        }

        .file-actions {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .file-btn {
            flex: 1;
            min-width: 70px;
            padding: 8px 5px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 12px;
            text-align: center;
            text-decoration: none;
            transition: all 0.3s;
            font-weight: 500;
        }

        .file-btn.download-btn {
            background: #4CAF50;
            color: white;
        }

        .file-btn.download-btn:hover {
            background: #45a049;
        }

        .file-btn.info-btn {
            background: #2196F3;
            color: white;
        }

        .file-btn.info-btn:hover {
            background: #1e88e5;
        }

        .file-btn.copy-btn {
            background: #FF9800;
            color: white;
        }

        .file-btn.copy-btn:hover {
            background: #fb8c00;
        }

        .file-btn.transform-btn {
            background: #9C27B0;
            color: white;
        }

        .file-btn.transform-btn:hover {
            background: #7b1fa2;
        }

        /* Pagination */
        .pagination {
            display: flex;
            justify-content: center;
            gap: 8px;
            margin-top: 30px;
            flex-wrap: wrap;
        }

        .page-btn {
            min-width: 40px;
            height: 40px;
            padding: 0 10px;
            border: none;
            background: #f0f0f0;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 14px;
        }

        .page-btn:hover {
            background: #764ba2;
            color: white;
        }

        .page-btn.active {
            background: #764ba2;
            color: white;
            font-weight: bold;
        }

        .page-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Loading */
        .loading {
            text-align: center;
            padding: 60px;
            color: #666;
            font-size: 1.2em;
        }

        .loading::after {
            content: '';
            display: inline-block;
            width: 20px;
            height: 20px;
            margin-left: 10px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #764ba2;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Modal */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            animation: fadeIn 0.3s;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 10px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            animation: slideUp 0.3s;
        }

        @keyframes slideUp {
            from {
                transform: translateY(50px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .modal-content h3 {
            color: #764ba2;
            margin-bottom: 20px;
            font-size: 1.5em;
        }

        .modal-content p {
            margin: 10px 0;
            line-height: 1.6;
        }

        .modal-content strong {
            color: #764ba2;
            min-width: 100px;
            display: inline-block;
        }

        .modal-preview {
            max-width: 100%;
            max-height: 200px;
            margin: 15px 0;
            border-radius: 5px;
            border: 1px solid #e0e0e0;
        }

        .modal-url {
            background: #f5f5f5;
            padding: 10px;
            border-radius: 5px;
            word-break: break-all;
            margin: 15px 0;
            font-family: monospace;
            font-size: 12px;
        }

        .modal-actions {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        .modal-btn {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
            min-width: 120px;
            color: white;
        }

        .modal-btn.download {
            background: #4CAF50;
        }

        .modal-btn.download:hover {
            background: #45a049;
        }

        .modal-btn.copy {
            background: #2196F3;
        }

        .modal-btn.copy:hover {
            background: #1e88e5;
        }

        .modal-btn.transform {
            background: #FF9800;
        }

        .modal-btn.transform:hover {
            background: #fb8c00;
        }

        .modal-btn.close {
            background: #f44336;
        }

        .modal-btn.close:hover {
            background: #da190b;
        }

        /* Transform Panel */
        .transform-panel {
            margin-top: 20px;
            padding: 15px;
            background: #f5f5f5;
            border-radius: 5px;
        }

        .transform-row {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
            align-items: center;
        }

        .transform-row label {
            min-width: 80px;
            font-weight: bold;
            color: #764ba2;
        }

        .transform-row input, .transform-row select {
            flex: 1;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }

        .transform-preview {
            margin-top: 15px;
            text-align: center;
        }

        .transform-preview img {
            max-width: 100%;
            max-height: 200px;
            border-radius: 5px;
            border: 1px solid #ddd;
        }

        /* Notification */
        .notification {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: #4CAF50;
            color: white;
            padding: 12px 24px;
            border-radius: 5px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            z-index: 1000;
            animation: slideUp 0.3s, fadeOut 0.3s 1.7s forwards;
            font-weight: 500;
        }

        @keyframes fadeOut {
            to {
                opacity: 0;
                transform: translateX(-50%) translateY(20px);
                visibility: hidden;
            }
        }

        /* Footer */
        footer {
            text-align: center;
            margin-top: 30px;
            color: white;
            font-size: 14px;
        }

        footer a {
            color: white;
            text-decoration: none;
            border-bottom: 1px dotted white;
            margin: 0 10px;
        }

        footer a:hover {
            border-bottom: 1px solid white;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }

            h1 {
                font-size: 2em;
            }

            .stats {
                gap: 10px;
            }

            .stats span {
                width: 100%;
            }

            .files-header {
                flex-direction: column;
                align-items: stretch;
            }
            
            .search-box {
                width: 100%;
            }
            
            .files-grid {
                grid-template-columns: 1fr;
            }

            .file-actions {
                flex-direction: column;
            }

            .file-btn {
                width: 100%;
            }

            .modal-content {
                padding: 20px;
                width: 95%;
            }

            .modal-actions {
                flex-direction: column;
            }

            .modal-btn {
                width: 100%;
            }
        }

        /* Dark mode support */
        @media (prefers-color-scheme: dark) {
            body {
                background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            }

            .upload-area, .files-section, .result, header, .modal-content {
                background: #1e1e2f;
                color: #fff;
            }

            h1, .files-header h3, .file-name {
                color: #a78bfa;
            }

            .stats span, .file-info, .url-box, .modal-url {
                background: #2d2d44;
                color: #ddd;
            }

            .file-card {
                background: #2d2d44;
                border-color: #404060;
            }

            .file-meta {
                color: #aaa;
            }

            .search-box {
                background: #2d2d44;
                border-color: #404060;
                color: white;
            }

            .search-box::placeholder {
                color: #888;
            }

            .page-btn {
                background: #2d2d44;
                color: white;
            }

            .page-btn:hover {
                background: #764ba2;
            }

            .url-box input {
                color: white;
            }

            .info-box {
                background: #1e3a5f;
                color: #fff;
            }

            .transform-panel {
                background: #2d2d44;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üê± MyCatBox <span>Cloudinary</span></h1>
            <p>Upload file ke Cloudinary - Gratis, Cepat, dan Permanen!</p>
            <div class="stats" id="stats">
                <span>üìä Loading stats...</span>
            </div>
        </header>

        <div class="upload-area" id="dropZone">
            <div class="upload-icon">‚òÅÔ∏è</div>
            <h3>Drag & Drop file di sini</h3>
            <p>atau</p>
            <button class="upload-btn" id="uploadBtn">Pilih File</button>
            <input type="file" id="fileInput" style="display: none;">
            <div class="file-info" id="fileInfo"></div>
            <div class="progress-bar" id="progressBar">
                <div class="progress-fill" id="progressFill"></div>
            </div>
            <div class="info-box cloudinary">
                <strong>‚òÅÔ∏è Cloudinary Storage:</strong> File disimpan permanen, bisa diresize, transformasi, dan CDN global. Maksimal 100MB.
            </div>
        </div>

        <div class="result" id="result"></div>

        <div class="files-section">
            <div class="files-header">
                <h3>üìã File Tersimpan</h3>
                <input type="text" class="search-box" id="searchBox" placeholder="Cari file... (min 3 karakter)" autocomplete="off">
            </div>
            <div id="filesList">
                <div class="loading">Memuat file...</div>
            </div>
            <div class="pagination" id="pagination"></div>
        </div>

        <footer>
            <p>
                ¬© 2024 MyCatBox - Powered by Cloudinary | 
                <a href="#" onclick="showAbout(); return false;">Tentang</a> | 
                <a href="#" onclick="showCloudinaryInfo(); return false;">Cloudinary Info</a> | 
                <a href="#" onclick="testAPIConnection(); return false;">Test Koneksi</a>
            </p>
        </footer>
    </div>

    <script>
        // ==================== KONFIGURASI ====================
        let currentPage = 1;
        let totalPages = 1;
        let searchTimeout;
        let allFiles = [];
        let isUploading = false;

        // Format file yang bisa ditransformasi (gambar)
        const TRANSFORMABLE_FORMATS = ['jpg', 'jpeg', 'png', 'gif', 'webp', 'bmp', 'tiff'];

        // ==================== TEST API CONNECTION ====================
        async function testAPIConnection() {
            try {
                showNotification('Mengecek koneksi ke server...', 'info');
                const response = await fetch('/api/test');
                const data = await response.json();
                
                if (data.success) {
                    showNotification('‚úÖ Koneksi ke Cloudinary berhasil!', 'success');
                    console.log('Server info:', data);
                } else {
                    showNotification('‚ùå Server merespon tapi ada error', 'error');
                }
            } catch (error) {
                console.error('API Test Error:', error);
                showNotification('‚ùå Gagal terkoneksi ke server. Pastikan server berjalan.', 'error');
            }
        }

        // ==================== LOAD STATS ====================
        async function loadStats() {
            try {
                const response = await fetch('/api/stats');
                const data = await response.json();
                
                if (data.success) {
                    const stats = data.stats;
                    document.getElementById('stats').innerHTML = `
                        <span>üì¶ Total File: ${stats.totalFiles}</span>
                        <span>üíæ Total Size: ${formatBytes(stats.totalSize)}</span>
                        <span>‚¨áÔ∏è Total Downloads: ${stats.totalDownloads}</span>
                        <span>üìã Formats: ${Object.keys(stats.formats || {}).length}</span>
                    `;
                }
            } catch (error) {
                console.error('Error loading stats:', error);
                document.getElementById('stats').innerHTML = '<span>‚ùå Gagal memuat stats</span>';
            }
        }

        // ==================== LOAD FILES ====================
        async function loadFiles(page = 1, search = '') {
            try {
                document.getElementById('filesList').innerHTML = '<div class="loading">Memuat file...</div>';
                
                let url = `/api/files?page=${page}`;
                if (search && search.length >= 3) {
                    url += `&search=${encodeURIComponent(search)}`;
                }
                
                console.log('Loading files from:', url);
                const response = await fetch(url);
                const data = await response.json();
                
                if (data.success) {
                    allFiles = data.files;
                    displayFiles(data.files);
                    updatePagination(data.page, data.totalPages);
                    totalPages = data.totalPages;
                    currentPage = data.page;
                } else {
                    document.getElementById('filesList').innerHTML = '<div class="loading">Error memuat file</div>';
                }
            } catch (error) {
                console.error('Error loading files:', error);
                document.getElementById('filesList').innerHTML = '<div class="loading">‚ùå Error memuat file. Periksa koneksi internet Anda.</div>';
            }
        }

        // ==================== DISPLAY FILES ====================
        function displayFiles(files) {
            const filesList = document.getElementById('filesList');
            
            if (files.length === 0) {
                filesList.innerHTML = '<div class="loading">üì≠ Belum ada file. Upload file pertama Anda ke Cloudinary!</div>';
                return;
            }

            let html = '<div class="files-grid">';
            files.forEach(file => {
                // Tentukan icon berdasarkan tipe file
                let fileIcon = getFileIcon(file.name);
                let isImage = isImageFile(file.name);
                
                // Format tanggal
                const uploadDate = new Date(file.uploadDate);
                const timeAgo = getTimeAgo(uploadDate);
                
                html += `
                    <div class="file-card">
                        ${isImage ? `<img src="${file.url}" class="file-thumbnail" alt="${file.name}" onerror="this.style.display='none'">` : ''}
                        <div class="file-name" title="${escapeHtml(file.name)}">${fileIcon} ${escapeHtml(truncateText(file.name, 40))}</div>
                        <div class="file-meta">
                            <span>üì¶ ${formatBytes(file.size)}</span>
                            <span>‚¨áÔ∏è ${file.downloads}</span>
                            <span class="cloudinary-badge">‚òÅÔ∏è Cloudinary</span>
                            <span>üìã ${file.format || 'file'}</span>
                            <span>üìÖ ${timeAgo}</span>
                        </div>
                        <div class="file-actions">
                            <a href="${file.url}" target="_blank" class="file-btn download-btn" onclick="trackDownload('${file.id}')">Download</a>
                            <button class="file-btn info-btn" onclick="showFileInfo('${file.id}')">Info</button>
                            <button class="file-btn copy-btn" onclick="copyToClipboard('${file.url}')">Copy URL</button>
                            ${isImage ? `<button class="file-btn transform-btn" onclick="showTransformModal('${file.publicId}', '${file.name}')">Transform</button>` : ''}
                        </div>
                    </div>
                `;
            });
            html += '</div>';
            
            filesList.innerHTML = html;
        }

        // ==================== GET FILE ICON ====================
        function getFileIcon(filename) {
            const ext = filename.split('.').pop().toLowerCase();
            const imageExt = ['jpg', 'jpeg', 'png', 'gif', 'webp', 'svg', 'bmp', 'ico'];
            const videoExt = ['mp4', 'webm', 'mov', 'avi', 'mkv', 'flv', 'wmv'];
            const audioExt = ['mp3', 'wav', 'ogg', 'm4a', 'aac', 'flac'];
            const docExt = ['pdf', 'doc', 'docx', 'txt', 'rtf', 'odt', 'xls', 'xlsx', 'ppt', 'pptx'];
            const archiveExt = ['zip', 'rar', '7z', 'tar', 'gz', 'bz2'];
            const codeExt = ['js', 'html', 'css', 'php', 'py', 'java', 'cpp', 'c', 'rb', 'go'];
            
            if (imageExt.includes(ext)) return 'üñºÔ∏è';
            if (videoExt.includes(ext)) return 'üé¨';
            if (audioExt.includes(ext)) return 'üéµ';
            if (docExt.includes(ext)) return 'üìÑ';
            if (archiveExt.includes(ext)) return 'üóúÔ∏è';
            if (codeExt.includes(ext)) return 'üíª';
            return 'üìÅ';
        }

        // ==================== CHECK IF IMAGE FILE ====================
        function isImageFile(filename) {
            const ext = filename.split('.').pop().toLowerCase();
            return ['jpg', 'jpeg', 'png', 'gif', 'webp', 'bmp', 'svg'].includes(ext);
        }

        // ==================== TRUNCATE TEXT ====================
        function truncateText(text, maxLength) {
            if (text.length <= maxLength) return text;
            return text.substr(0, maxLength) + '...';
        }

        // ==================== GET TIME AGO ====================
        function getTimeAgo(date) {
            const seconds = Math.floor((new Date() - date) / 1000);
            
            let interval = seconds / 31536000;
            if (interval > 1) return Math.floor(interval) + ' tahun lalu';
            
            interval = seconds / 2592000;
            if (interval > 1) return Math.floor(interval) + ' bulan lalu';
            
            interval = seconds / 86400;
            if (interval > 1) return Math.floor(interval) + ' hari lalu';
            
            interval = seconds / 3600;
            if (interval > 1) return Math.floor(interval) + ' jam lalu';
            
            interval = seconds / 60;
            if (interval > 1) return Math.floor(interval) + ' menit lalu';
            
            return 'baru saja';
        }

        // ==================== UPDATE PAGINATION ====================
        function updatePagination(current, total) {
            const pagination = document.getElementById('pagination');
            if (total <= 1) {
                pagination.innerHTML = '';
                return;
            }
            
            let html = '';
            
            if (current > 1) {
                html += `<button class="page-btn" onclick="changePage(${current - 1})">‚Üê</button>`;
            }
            
            const maxVisible = 5;
            let start = Math.max(1, current - Math.floor(maxVisible / 2));
            let end = Math.min(total, start + maxVisible - 1);
            
            if (end - start + 1 < maxVisible) {
                start = Math.max(1, end - maxVisible + 1);
            }
            
            if (start > 1) {
                html += `<button class="page-btn" onclick="changePage(1)">1</button>`;
                if (start > 2) {
                    html += `<span class="page-btn" style="background: none; cursor: default;">...</span>`;
                }
            }
            
            for (let i = start; i <= end; i++) {
                html += `<button class="page-btn ${i === current ? 'active' : ''}" onclick="changePage(${i})">${i}</button>`;
            }
            
            if (end < total) {
                if (end < total - 1) {
                    html += `<span class="page-btn" style="background: none; cursor: default;">...</span>`;
                }
                html += `<button class="page-btn" onclick="changePage(${total})">${total}</button>`;
            }
            
            if (current < total) {
                html += `<button class="page-btn" onclick="changePage(${current + 1})">‚Üí</button>`;
            }
            
            pagination.innerHTML = html;
        }

        // ==================== CHANGE PAGE ====================
        function changePage(page) {
            if (page < 1 || page > totalPages) return;
            currentPage = page;
            const search = document.getElementById('searchBox').value;
            loadFiles(page, search);
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        // ==================== TRACK DOWNLOAD ====================
        async function trackDownload(fileId) {
            try {
                await fetch(`/api/files/${fileId}/download`, { method: 'POST' });
                loadStats();
                const file = allFiles.find(f => f.id === fileId);
                if (file) {
                    file.downloads++;
                }
            } catch (error) {
                console.error('Error tracking download:', error);
            }
        }

        // ==================== SHOW FILE INFO ====================
        async function showFileInfo(fileId) {
            try {
                let file = allFiles.find(f => f.id === fileId);
                
                if (!file) {
                    const response = await fetch(`/api/files/${fileId}`);
                    const data = await response.json();
                    if (data.success) {
                        file = data.file;
                    }
                }
                
                if (file) {
                    showFileModal(file);
                } else {
                    showNotification('File tidak ditemukan', 'error');
                }
            } catch (error) {
                console.error('Error getting file info:', error);
                showNotification('Error mendapatkan info file', 'error');
            }
        }

        // ==================== SHOW FILE MODAL ====================
        function showFileModal(file) {
            const existingModal = document.querySelector('.modal');
            if (existingModal) {
                existingModal.remove();
            }

            const modal = document.createElement('div');
            modal.className = 'modal';
            
            const isImage = file.format && TRANSFORMABLE_FORMATS.includes(file.format);
            
            modal.innerHTML = `
                <div class="modal-content">
                    <h3>üìã Detail File (Cloudinary)</h3>
                    ${isImage ? `<img src="${file.url}" class="modal-preview" alt="${file.name}">` : ''}
                    <p><strong>Nama:</strong> ${escapeHtml(file.name)}</p>
                    <p><strong>Ukuran:</strong> ${formatBytes(file.size)}</p>
                    <p><strong>Tipe:</strong> ${file.mimeType || file.format || 'Unknown'}</p>
                    <p><strong>Service:</strong> ‚òÅÔ∏è Cloudinary</p>
                    <p><strong>Public ID:</strong> ${file.publicId || 'N/A'}</p>
                    <p><strong>Upload:</strong> ${new Date(file.uploadDate).toLocaleString('id-ID')}</p>
                    <p><strong>Downloads:</strong> ${file.downloads}</p>
                    ${file.width ? `<p><strong>Dimensi:</strong> ${file.width} x ${file.height}</p>` : ''}
                    <p><strong>URL:</strong></p>
                    <div class="modal-url">${file.url}</div>
                    <div class="modal-actions">
                        <button class="modal-btn download" onclick="window.open('${file.url}')">Download</button>
                        <button class="modal-btn copy" onclick="copyToClipboard('${file.url}')">Copy URL</button>
                        ${isImage ? `<button class="modal-btn transform" onclick="showTransformModal('${file.publicId}', '${file.name}'); this.closest('.modal').remove();">Transform</button>` : ''}
                        <button class="modal-btn close" onclick="this.closest('.modal').remove()">Tutup</button>
                    </div>
                </div>
            `;
            
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.remove();
                }
            });
            
            document.body.appendChild(modal);
        }

        // ==================== SHOW TRANSFORM MODAL ====================
        async function showTransformModal(publicId, fileName) {
            const existingModal = document.querySelector('.modal');
            if (existingModal) {
                existingModal.remove();
            }

            const modal = document.createElement('div');
            modal.className = 'modal';
            
            modal.innerHTML = `
                <div class="modal-content">
                    <h3>üñºÔ∏è Transformasi Gambar</h3>
                    <p>File: ${escapeHtml(fileName)}</p>
                    <p>Public ID: ${publicId}</p>
                    
                    <div class="transform-panel">
                        <div class="transform-row">
                            <label>Width:</label>
                            <input type="number" id="transformWidth" placeholder="px" min="1" max="2000">
                        </div>
                        <div class="transform-row">
                            <label>Height:</label>
                            <input type="number" id="transformHeight" placeholder="px" min="1" max="2000">
                        </div>
                        <div class="transform-row">
                            <label>Crop:</label>
                            <select id="transformCrop">
                                <option value="scale">Scale</option>
                                <option value="fit">Fit</option>
                                <option value="fill">Fill</option>
                                <option value="thumb">Thumbnail</option>
                                <option value="crop">Crop</option>
                            </select>
                        </div>
                        <div class="transform-row">
                            <label>Gravity:</label>
                            <select id="transformGravity">
                                <option value="center">Center</option>
                                <option value="face">Face</option>
                                <option value="faces">Faces</option>
                                <option value="north">North</option>
                                <option value="south">South</option>
                                <option value="east">East</option>
                                <option value="west">West</option>
                            </select>
                        </div>
                        <div class="transform-row">
                            <label>Effect:</label>
                            <select id="transformEffect">
                                <option value="">None</option>
                                <option value="grayscale">Grayscale</option>
                                <option value="sepia">Sepia</option>
                                <option value="negate">Negate</option>
                                <option value="blur:300">Blur</option>
                                <option value="sharpen">Sharpen</option>
                                <option value="brightness:50">Brightness</option>
                                <option value="contrast:50">Contrast</option>
                            </select>
                        </div>
                        <div class="transform-row">
                            <label>Quality:</label>
                            <select id="transformQuality">
                                <option value="">Auto</option>
                                <option value="100">100%</option>
                                <option value="80">80%</option>
                                <option value="60">60%</option>
                                <option value="40">40%</option>
                            </select>
                        </div>
                        <button class="action-btn transform" onclick="applyTransform('${publicId}')" style="width: 100%; margin-top: 15px;">Terapkan Transformasi</button>
                    </div>

                    <div id="transformResult" style="margin-top: 20px; display: none;">
                        <h4>Hasil Transformasi:</h4>
                        <div class="transform-preview">
                            <img id="transformedImage" src="" alt="Transformed">
                        </div>
                        <div class="url-box" style="margin-top: 10px;">
                            <input type="text" id="transformedUrl" readonly>
                            <button class="copy-btn" onclick="copyToClipboard(document.getElementById('transformedUrl').value)">Copy</button>
                        </div>
                    </div>

                    <div class="modal-actions" style="margin-top: 20px;">
                        <button class="modal-btn close" onclick="this.closest('.modal').remove()">Tutup</button>
                    </div>
                </div>
            `;
            
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.remove();
                }
            });
            
            document.body.appendChild(modal);
        }

        // ==================== APPLY TRANSFORM ====================
        async function applyTransform(publicId) {
            const width = document.getElementById('transformWidth').value;
            const height = document.getElementById('transformHeight').value;
            const crop = document.getElementById('transformCrop').value;
            const gravity = document.getElementById('transformGravity').value;
            const effect = document.getElementById('transformEffect').value;
            const quality = document.getElementById('transformQuality').value;

            let params = new URLSearchParams();
            if (width) params.append('width', width);
            if (height) params.append('height', height);
            if (crop) params.append('crop', crop);
            if (gravity) params.append('gravity', gravity);
            if (effect) params.append('effect', effect);
            if (quality) params.append('quality', quality);

            try {
                showNotification('Menerapkan transformasi...', 'info');
                
                const response = await fetch(`/api/transform/${publicId}?${params.toString()}`);
                const data = await response.json();
                
                if (data.success) {
                    document.getElementById('transformedImage').src = data.url;
                    document.getElementById('transformedUrl').value = data.url;
                    document.getElementById('transformResult').style.display = 'block';
                    showNotification('‚úÖ Transformasi berhasil!', 'success');
                } else {
                    showNotification('‚ùå Transformasi gagal', 'error');
                }
            } catch (error) {
                console.error('Transform error:', error);
                showNotification('Error transformasi', 'error');
            }
        }

        // ==================== SHOW ABOUT MODAL ====================
        function showAbout() {
            const modal = document.createElement('div');
            modal.className = 'modal';
            
            modal.innerHTML = `
                <div class="modal-content">
                    <h3>üê± Tentang MyCatBox</h3>
                    <p>MyCatBox adalah layanan upload file gratis yang menggunakan <strong>Cloudinary</strong> sebagai storage.</p>
                    <p><strong>Fitur Cloudinary:</strong></p>
                    <ul style="margin-left: 20px; line-height: 1.8;">
                        <li>‚úÖ Penyimpanan permanen</li>
                        <li>‚úÖ Semua format file didukung</li>
                        <li>‚úÖ Transformasi gambar (resize, crop, effect)</li>
                        <li>‚úÖ CDN global - akses cepat dari mana saja</li>
                        <li>‚úÖ Optimasi otomatis</li>
                        <li>‚úÖ Gratis 25GB storage</li>
                    </ul>
                    <p><strong>Version:</strong> 3.0 (Cloudinary)</p>
                    <div class="modal-actions">
                        <button class="modal-btn close" onclick="this.closest('.modal').remove()">Tutup</button>
                    </div>
                </div>
            `;
            
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.remove();
                }
            });
            
            document.body.appendChild(modal);
        }

        // ==================== SHOW CLOUDINARY INFO ====================
        async function showCloudinaryInfo() {
            try {
                const response = await fetch('/api/cloudinary/usage');
                const data = await response.json();
                
                if (data.success) {
                    const usage = data.usage;
                    const modal = document.createElement('div');
                    modal.className = 'modal';
                    
                    modal.innerHTML = `
                        <div class="modal-content">
                            <h3>‚òÅÔ∏è Cloudinary Info</h3>
                            <p><strong>Plan:</strong> ${usage.plan || 'Free'}</p>
                            <p><strong>Credits:</strong> ${usage.credits?.usage || 0} / ${usage.credits?.limit || 'Unlimited'}</p>
                            <p><strong>Storage:</strong> ${formatBytes(usage.usage?.storage || 0)}</p>
                            <p><strong>Bandwidth:</strong> ${formatBytes(usage.usage?.bandwidth || 0)}</p>
                            <p><strong>Requests:</strong> ${usage.usage?.requests || 0}</p>
                            <p><strong>Transformations:</strong> ${usage.usage?.transformations || 0}</p>
                            <div class="modal-actions">
                                <button class="modal-btn close" onclick="this.closest('.modal').remove()">Tutup</button>
                            </div>
                        </div>
                    `;
                    
                    modal.addEventListener('click', (e) => {
                        if (e.target === modal) {
                            modal.remove();
                        }
                    });
                    
                    document.body.appendChild(modal);
                }
            } catch (error) {
                showNotification('Gagal memuat info Cloudinary', 'error');
            }
        }

        // ==================== FORMAT BYTES ====================
        function formatBytes(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        // ==================== ESCAPE HTML ====================
        function escapeHtml(unsafe) {
            if (!unsafe) return '';
            return unsafe
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

        // ==================== UPLOAD FILE ====================
        async function uploadFile(file) {
            if (isUploading) {
                showNotification('Upload sedang berlangsung...', 'warning');
                return;
            }

            const formData = new FormData();
            formData.append('file', file);

            const progressBar = document.getElementById('progressBar');
            const progressFill = document.getElementById('progressFill');
            const result = document.getElementById('result');
            const fileInfo = document.getElementById('fileInfo');
            const uploadBtn = document.getElementById('uploadBtn');
            const dropZone = document.getElementById('dropZone');

            isUploading = true;
            progressBar.style.display = 'block';
            result.style.display = 'none';
            progressFill.style.width = '0%';
            uploadBtn.disabled = true;
            dropZone.style.opacity = '0.7';

            fileInfo.innerHTML = `
                <strong>File:</strong> ${escapeHtml(file.name)}<br>
                <strong>Size:</strong> ${formatBytes(file.size)}<br>
                <strong>Status:</strong> Mengupload ke Cloudinary...
            `;

            try {
                const xhr = new XMLHttpRequest();
                
                xhr.upload.addEventListener('progress', (e) => {
                    if (e.lengthComputable) {
                        const percent = (e.loaded / e.total) * 100;
                        progressFill.style.width = percent + '%';
                        fileInfo.innerHTML = `
                            <strong>File:</strong> ${escapeHtml(file.name)}<br>
                            <strong>Size:</strong> ${formatBytes(file.size)}<br>
                            <strong>Progress:</strong> ${Math.round(percent)}%<br>
                            <strong>Uploaded:</strong> ${formatBytes(e.loaded)} / ${formatBytes(e.total)}
                        `;
                    }
                });

                xhr.addEventListener('load', function() {
                    progressBar.style.display = 'none';
                    uploadBtn.disabled = false;
                    dropZone.style.opacity = '1';
                    isUploading = false;
                    
                    try {
                        console.log('Response:', xhr.responseText);
                        
                        const data = JSON.parse(xhr.responseText);
                        
                        if (xhr.status === 200 && data.success) {
                            if (data.url) {
                                showSuccess(data);
                                loadFiles(currentPage);
                                loadStats();
                                fileInfo.innerHTML = '';
                                fileInput.value = '';
                            } else {
                                showError('Response tidak valid: URL tidak ditemukan');
                            }
                        } else {
                            showError(data.error || 'Upload gagal dengan status: ' + xhr.status);
                        }
                    } catch (e) {
                        console.error('Parse error:', e);
                        showError('Error parsing response: ' + e.message);
                    }
                });

                xhr.addEventListener('error', function() {
                    progressBar.style.display = 'none';
                    uploadBtn.disabled = false;
                    dropZone.style.opacity = '1';
                    isUploading = false;
                    showError('Network error - periksa koneksi internet Anda');
                    fileInfo.innerHTML = '';
                });

                xhr.addEventListener('timeout', function() {
                    progressBar.style.display = 'none';
                    uploadBtn.disabled = false;
                    dropZone.style.opacity = '1';
                    isUploading = false;
                    showError('Upload timeout - file terlalu besar atau koneksi lambat');
                    fileInfo.innerHTML = '';
                });

                xhr.timeout = 300000;
                xhr.open('POST', '/api/upload');
                xhr.send(formData);
            } catch (error) {
                console.error('Upload error:', error);
                progressBar.style.display = 'none';
                uploadBtn.disabled = false;
                dropZone.style.opacity = '1';
                isUploading = false;
                showError('Error: ' + error.message);
                fileInfo.innerHTML = '';
            }
        }

        // ==================== SHOW SUCCESS ====================
        function showSuccess(data) {
            const result = document.getElementById('result');
            result.className = 'result success';
            
            const isImage = data.format && TRANSFORMABLE_FORMATS.includes(data.format);
            
            result.innerHTML = `
                <h3>‚úÖ Upload Berhasil ke Cloudinary!</h3>
                <p>${data.message || 'File tersimpan permanen di Cloudinary'}</p>
                <div class="url-box">
                    <input type="text" value="${data.url}" readonly id="successUrl">
                    <button class="copy-btn" onclick="copyToClipboard(document.getElementById('successUrl').value)">Copy</button>
                </div>
                <div class="action-buttons">
                    <button class="action-btn open" onclick="window.open('${data.url}')">Buka URL</button>
                    <button class="action-btn download" onclick="downloadFile('${data.url}', '${data.fileName || 'download'}')">Download</button>
                    ${isImage ? `<button class="action-btn transform" onclick="showTransformModal('${data.publicId}', '${data.fileName}')">Transform</button>` : ''}
                </div>
                <p style="margin-top: 15px; font-size: 12px; color: #666;">
                    Public ID: ${data.publicId || 'N/A'} | Format: ${data.format || 'file'} | Size: ${formatBytes(data.fileSize || 0)}
                </p>
            `;
            result.style.display = 'block';
        }

        // ==================== SHOW ERROR ====================
        function showError(message) {
            const result = document.getElementById('result');
            result.className = 'result error';
            result.innerHTML = `
                <h3>‚ùå Error!</h3>
                <p>${message}</p>
                <div style="display: flex; gap: 10px; margin-top: 15px;">
                    <button class="action-btn download" style="background: #4CAF50; flex: 1;" onclick="window.location.reload()">Refresh Halaman</button>
                    <button class="action-btn open" style="background: #f44336; flex: 1;" onclick="this.parentElement.parentElement.style.display='none'">Tutup</button>
                </div>
                <p style="margin-top: 10px; font-size: 12px;">Coba test koneksi dengan klik "Test Koneksi" di footer</p>
            `;
            result.style.display = 'block';
        }

        // ==================== DOWNLOAD FILE ====================
        function downloadFile(url, filename) {
            const link = document.createElement('a');
            link.href = url;
            link.download = filename || 'download';
            link.target = '_blank';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // ==================== COPY TO CLIPBOARD ====================
        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                showNotification('‚úì URL berhasil dicopy!');
            }).catch(() => {
                const textarea = document.createElement('textarea');
                textarea.value = text;
                document.body.appendChild(textarea);
                textarea.select();
                document.execCommand('copy');
                document.body.removeChild(textarea);
                showNotification('‚úì URL berhasil dicopy!');
            });
        }

        // ==================== SHOW NOTIFICATION ====================
        function showNotification(message, type = 'success') {
            const notification = document.createElement('div');
            notification.className = 'notification';
            notification.textContent = message;
            
            if (type === 'error') {
                notification.style.background = '#f44336';
            } else if (type === 'warning') {
                notification.style.background = '#ff9800';
            } else if (type === 'info') {
                notification.style.background = '#2196F3';
            } else {
                notification.style.background = '#4CAF50';
            }
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 2000);
        }

        // ==================== DRAG & DROP HANDLERS ====================
        const dropZone = document.getElementById('dropZone');
        const fileInput = document.getElementById('fileInput');
        const uploadBtn = document.getElementById('uploadBtn');

        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            dropZone.addEventListener(eventName, preventDefaults, false);
            document.body.addEventListener(eventName, preventDefaults, false);
        });

        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }

        ['dragenter', 'dragover'].forEach(eventName => {
            dropZone.addEventListener(eventName, highlight, false);
        });

        ['dragleave', 'drop'].forEach(eventName => {
            dropZone.addEventListener(eventName, unhighlight, false);
        });

        function highlight() {
            dropZone.classList.add('dragover');
        }

        function unhighlight() {
            dropZone.classList.remove('dragover');
        }

        dropZone.addEventListener('drop', handleDrop, false);

        function handleDrop(e) {
            const dt = e.dataTransfer;
            const file = dt.files[0];
            
            if (file) {
                handleFile(file);
            }
        }

        uploadBtn.addEventListener('click', () => {
            if (!isUploading) {
                fileInput.click();
            } else {
                showNotification('Upload sedang berlangsung...', 'warning');
            }
        });

        fileInput.addEventListener('change', () => {
            const file = fileInput.files[0];
            if (file) {
                handleFile(file);
            }
        });

        function handleFile(file) {
            if (file.size > 100 * 1024 * 1024) {
                showError('File terlalu besar! Maksimal 100MB');
                fileInput.value = '';
                return;
            }
            
            const fileType = file.type || 'Unknown';
            const fileName = file.name;
            
            document.getElementById('fileInfo').innerHTML = `
                <strong>File:</strong> ${escapeHtml(fileName)}<br>
                <strong>Size:</strong> ${formatBytes(file.size)}<br>
                <strong>Tipe:</strong> ${fileType}<br>
                <strong>Status:</strong> Siap upload ke Cloudinary
            `;
            
            uploadFile(file);
        }

        // ==================== SEARCH WITH DEBOUNCE ====================
        document.getElementById('searchBox').addEventListener('input', (e) => {
            clearTimeout(searchTimeout);
            const searchValue = e.target.value;
            
            searchTimeout = setTimeout(() => {
                if (searchValue.length >= 3 || searchValue.length === 0) {
                    loadFiles(1, searchValue);
                }
            }, 500);
        });

        // ==================== KEYBOARD SHORTCUTS ====================
        document.addEventListener('keydown', (e) => {
            if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
                e.preventDefault();
                document.getElementById('searchBox').focus();
            }
            
            if (e.key === 'Escape') {
                const modal = document.querySelector('.modal');
                if (modal) {
                    modal.remove();
                }
            }
        });

        // ==================== INITIAL LOAD ====================
        window.addEventListener('load', () => {
            setTimeout(() => {
                testAPIConnection();
            }, 500);
            
            loadStats();
            loadFiles();
        });

        // ==================== AUTO REFRESH ====================
        setInterval(() => {
            loadStats();
            if (!document.hidden) {
                loadFiles(currentPage, document.getElementById('searchBox').value);
            }
        }, 30000);

        // ==================== HANDLE VISIBILITY CHANGE ====================
        document.addEventListener('visibilitychange', () => {
            if (!document.hidden) {
                loadStats();
                loadFiles(currentPage, document.getElementById('searchBox').value);
            }
        });
    </script>
</body>
</html>
